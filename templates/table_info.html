<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ table.schema_name }}.{{ table.table_name }} - å…ƒæ•°æ®ç®¡ç†</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ—„ï¸</text></svg>">
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/bootstrap-icons.min.css">
    <style>
        .db-icon {
            font-size: 1.5rem;
            padding: 0.5rem;
            border-radius: 0.3rem;
            margin-right: 0.5rem;
        }
        .mysql-icon {
            background-color: #4CAF50;
            color: white;
        }
        .postgresql-icon {
            background-color: #336791;
            color: white;
        }
        .hive-icon {
            background-color: #FDE74C;
            color: #222;
        }
        .sqlserver-icon {
            background-color: #0078D4;
            color: white;
        }
        .key-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
            border-radius: 0.3rem;
        }
    </style>
</head>
<body>
    <div class="container mt-1">
        <!-- é¢åŒ…å±‘è·¯å¾„ -->
        <nav aria-label="breadcrumb" class="mb-1">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="/databases" class="text-decoration-none">æ•°æ®åº“</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="/database/{{ database.id }}/tables" class="text-decoration-none">
                        {{ database.db_name }}
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">{{ table.table_name }}</li>
            </ol>
        </nav>
        
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h1 class="mb-0 mt-0" style="margin: 5px 0;">{{ table.table_name }}</h1>
            <button type="button" class="btn btn-primary" id="editRemarkBtn">
                <i class="bi bi-pencil"></i> ç¼–è¾‘
            </button>
        </div>
        
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center" id="infoCardHeader" style="cursor: pointer;">
                <h5 class="card-title mb-0">åŸºæœ¬ä¿¡æ¯</h5>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleInfoBtn">
                    <i class="bi bi-chevron-up" id="toggleIcon"></i>
                </button>
            </div>
            <div class="card-body" id="infoBody">
                <div class="row">
                    <div class="col-md-6">
                        <strong>è¡¨åï¼š</strong> {{ table.table_name }}
                    </div>
                    <div class="col-md-6">
                        <strong>æ³¨é‡Šï¼š</strong> {{ table.table_comment or 'æ— ' }}
                    </div>
                    <div class="col-12 mt-2">
                        <strong>å¤‡æ³¨ï¼š</strong> <span id="remarkText">{{ table.remark or 'æ— ' }}</span>
                        <!-- ç¼–è¾‘æ¨¡å¼ä¸‹çš„è¾“å…¥æ¡† -->
                        <div id="remarkEdit" style="display: none; margin-top: 10px;">
                            <textarea class="form-control" id="remarkTextarea" rows="3" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯">{{ table.remark or '' }}</textarea>
                            <div class="d-flex justify-content-end mt-2">
                                <button type="button" class="btn btn-sm btn-secondary me-2" id="cancelBtn">å–æ¶ˆ</button>
                                <button type="button" class="btn btn-sm btn-primary" id="saveBtn">ä¿å­˜</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å­—æ®µä¿¡æ¯ -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">å­—æ®µä¿¡æ¯</h5>
            </div>
            <div class="card-body">
                <!-- ç­›é€‰æ¡† -->
                <div class="mb-3">
                    <input type="text" class="form-control" id="columnFilter" placeholder="è¾“å…¥å…³é”®å­—ç­›é€‰å­—æ®µï¼ˆè‡³å°‘2ä¸ªå­—ç¬¦ï¼‰">
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 10%;">åºå·</th>
                                <th style="width: 30%;">å­—æ®µå</th>
                                <th style="width: 10%;">å­—æ®µç±»å‹</th>
                                <th style="width: 10%;">KEY</th>
                                <th style="width: 40%;">å¤‡æ³¨</th>
                            </tr>
                        </thead>
                        <tbody id="columnsTableBody">
                            {% for column in columns %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ column.column_name }}</td>
                                <td>{{ column.column_type }}</td>
                                <td>
                                    {% if column.is_primary %}
                                    <span class="key-badge bg-primary text-white">PK</span>
                                    {% elif column.is_unique %}
                                    <span class="key-badge bg-info text-white">UK</span>
                                    {% else %}
                                    -{% endif %}
                                </td>
                                <td>{{ column.column_comment or 'æ— ' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        // åŸºæœ¬ä¿¡æ¯å¡ç‰‡æŠ˜å /å±•å¼€åŠŸèƒ½
        const toggleInfoBtn = document.getElementById('toggleInfoBtn');
        const infoCardHeader = document.getElementById('infoCardHeader');
        const infoBody = document.getElementById('infoBody');
        const toggleIcon = document.getElementById('toggleIcon');
        
        // æŠ˜å /å±•å¼€å‡½æ•°
        function toggleInfo() {
            if (infoBody.style.display === 'none') {
                // å±•å¼€
                infoBody.style.display = 'block';
                toggleIcon.classList.remove('bi-chevron-down');
                toggleIcon.classList.add('bi-chevron-up');
            } else {
                // æŠ˜å 
                infoBody.style.display = 'none';
                toggleIcon.classList.remove('bi-chevron-up');
                toggleIcon.classList.add('bi-chevron-down');
            }
        }
        
        // æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        toggleInfoBtn.addEventListener('click', toggleInfo);
        
        // æ ‡é¢˜æ åŒå‡»äº‹ä»¶
        infoCardHeader.addEventListener('dblclick', toggleInfo);
        
        // ç¼–è¾‘å¤‡æ³¨åŠŸèƒ½
        const editRemarkBtn = document.getElementById('editRemarkBtn');
        const remarkText = document.getElementById('remarkText');
        const remarkEdit = document.getElementById('remarkEdit');
        const remarkTextarea = document.getElementById('remarkTextarea');
        const saveBtn = document.getElementById('saveBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        
        // è¿›å…¥ç¼–è¾‘æ¨¡å¼
        editRemarkBtn.addEventListener('click', function() {
            remarkText.style.display = 'none';
            remarkEdit.style.display = 'block';
            editRemarkBtn.disabled = true;
        });
        
        // ä¿å­˜å¤‡æ³¨
        saveBtn.addEventListener('click', function() {
            const newRemark = remarkTextarea.value;
            
            // å‘é€AJAXè¯·æ±‚ä¿å­˜å¤‡æ³¨
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/database/{{ database.id }}/table/{{ table.id }}/update-remark', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    // æ›´æ–°æ˜¾ç¤º
                    remarkText.textContent = newRemark || 'æ— ';
                    remarkText.style.display = 'inline';
                    remarkEdit.style.display = 'none';
                    editRemarkBtn.disabled = false;
                }
            };
            
            xhr.send('remark=' + encodeURIComponent(newRemark));
        });
        
        // å–æ¶ˆç¼–è¾‘
        cancelBtn.addEventListener('click', function() {
            remarkText.style.display = 'inline';
            remarkEdit.style.display = 'none';
            editRemarkBtn.disabled = false;
        });
        
        // å­—æ®µç­›é€‰åŠŸèƒ½
        const columnFilter = document.getElementById('columnFilter');
        const columnsTableBody = document.getElementById('columnsTableBody');
        const columnRows = columnsTableBody.getElementsByTagName('tr');
        
        columnFilter.addEventListener('input', function() {
            const keyword = this.value.toLowerCase().trim();
            
            // å¦‚æœå…³é”®å­—é•¿åº¦å°äº2ï¼Œæ˜¾ç¤ºæ‰€æœ‰è¡Œ
            if (keyword.length < 2) {
                for (let i = 0; i < columnRows.length; i++) {
                    columnRows[i].style.display = '';
                }
                return;
            }
            
            // éå†æ‰€æœ‰è¡Œï¼Œè¿›è¡Œç­›é€‰
            for (let i = 0; i < columnRows.length; i++) {
                const row = columnRows[i];
                const cells = row.getElementsByTagName('td');
                
                // å­—æ®µååœ¨ç¬¬2ä¸ªå•å…ƒæ ¼ï¼Œå­—æ®µç±»å‹åœ¨ç¬¬3ä¸ªï¼Œå¤‡æ³¨åœ¨ç¬¬5ä¸ª
                const columnName = cells[1].textContent.toLowerCase();
                const columnType = cells[2].textContent.toLowerCase();
                const columnComment = cells[4].textContent.toLowerCase();
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«å…³é”®å­—
                if (columnName.includes(keyword) || columnType.includes(keyword) || columnComment.includes(keyword)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });
    </script>
</body>
</html>