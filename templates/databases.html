<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…ƒæ•°æ®ç®¡ç†</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ—„ï¸</text></svg>">
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/bootstrap-icons.min.css">
    <style>
        .card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .db-icon {
            font-size: 2rem;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .mysql-icon {
            background-color: #4CAF50;
            color: white;
        }
        .postgresql-icon {
            background-color: #336791;
            color: white;
        }
        .hive-icon {
            background-color: #FDE74C;
            color: #222;
        }
        .sqlserver-icon {
            background-color: #0078D4;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>æ•°æ®åº“</h1>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDatabaseModal">
                <i class="bi bi-plus"></i> å¢åŠ 
            </button>
        </div>
        
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4">
            {% for db in databases %}
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <!-- æ•°æ®åº“ç±»å‹å›¾æ ‡ -->
                        {% if db.db_type == 'MySQL' %}
                        <a href="/database/{{ db.id }}/tables" class="text-decoration-none">
                            <div class="db-icon mysql-icon text-center" style="cursor: pointer;">
                                <i class="bi bi-database-fill"></i>
                            </div>
                        </a>
                        {% elif db.db_type == 'PostgreSQL' %}
                        <a href="/database/{{ db.id }}/tables" class="text-decoration-none">
                            <div class="db-icon postgresql-icon text-center" style="cursor: pointer;">
                                <i class="bi bi-database-fill"></i>
                            </div>
                        </a>
                        {% elif db.db_type == 'Hive' %}
                        <a href="/database/{{ db.id }}/tables" class="text-decoration-none">
                            <div class="db-icon hive-icon text-center" style="cursor: pointer;">
                                <i class="bi bi-database-fill"></i>
                            </div>
                        </a>
                        {% elif db.db_type == 'SqlServer' %}
                        <a href="/database/{{ db.id }}/tables" class="text-decoration-none">
                            <div class="db-icon sqlserver-icon text-center" style="cursor: pointer;">
                                <i class="bi bi-database-fill"></i>
                            </div>
                        </a>
                        {% endif %}
                        
                        <h5 class="card-title">
                            <a href="/database/{{ db.id }}/tables" class="text-decoration-none">
                                {{ db.db_alias }}
                            </a>
                        </h5>
                        <p class="card-text">
                            <strong>ç±»å‹ï¼š</strong>{{ db.db_type }}<br>
                            <strong>åœ°å€ï¼š</strong>{{ db.db_host }}:{{ db.db_port }}<br>
                            <strong>åº“åï¼š</strong>{{ db.db_name }}
                        </p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- æ–°å¢æ•°æ®åº“æ¨¡æ€æ¡† -->
    <div class="modal fade" id="addDatabaseModal" tabindex="-1" aria-labelledby="addDatabaseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addDatabaseModalLabel">æ–°å¢æ•°æ®åº“</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addDatabaseForm" method="POST" action="/databases/add">
                    <div class="modal-body">
                        <style>
                            .edit-label {
                                width: calc(25% - 70px); /* å†å‡å°‘30pxï¼Œæ€»å…±ç¼©å°70px */
                                min-width: 100px;
                            }
                            .edit-input {
                                width: calc(75% + 70px); /* å¯¹åº”å¢åŠ 70px */
                            }
                        </style>
                        <div class="row mb-3 align-items-center">
                            <label for="dbType" class="col-form-label edit-label">æ•°æ®åº“ç±»å‹ <span class="text-danger">*</span></label>
                            <div class="edit-input">
                                <select class="form-select" id="dbType" name="db_type" required>
                                    <option value="">è¯·é€‰æ‹©æ•°æ®åº“ç±»å‹</option>
                                    <option value="MySQL">MySQL</option>
                                    <option value="PostgreSQL">PostgreSQL</option>
                                    <option value="Hive">Hive</option>
                                    <option value="SqlServer">SqlServer</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3 align-items-center">
                            <label for="dbAlias" class="col-form-label edit-label">æ•°æ®åº“åˆ«å <span class="text-danger">*</span></label>
                            <div class="edit-input">
                                <input type="text" class="form-control" id="dbAlias" name="db_alias" placeholder="è¯·è¾“å…¥ä¸­æ–‡åˆ«å" required>
                            </div>
                        </div>
                        <div class="row mb-3 align-items-center">
                            <label for="dbHost" class="col-form-label edit-label">åœ°å€ <span class="text-danger">*</span></label>
                            <div class="edit-input">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="dbHost" name="db_host" placeholder="è¯·è¾“å…¥IPåœ°å€" required>
                                    <input type="number" class="form-control" id="dbPort" name="db_port" placeholder="ç«¯å£" min="1" max="65535" required>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3 align-items-center">
                            <label for="dbName" class="col-form-label edit-label">æ•°æ®åº“å <span class="text-danger">*</span></label>
                            <div class="edit-input">
                                <input type="text" class="form-control" id="dbName" name="db_name" placeholder="è¯·è¾“å…¥æ•°æ®åº“å" required>
                            </div>
                        </div>
                        <div class="row mb-3 align-items-center">
                            <label for="dbUser" class="col-form-label edit-label">ç”¨æˆ·å <span class="text-danger">*</span></label>
                            <div class="edit-input">
                                <input type="text" class="form-control" id="dbUser" name="db_user" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                            </div>
                        </div>
                        <div class="row mb-3 align-items-center">
                            <label for="dbPassword" class="col-form-label edit-label">å¯†ç  <span class="text-danger">*</span></label>
                            <div class="edit-input">
                                <input type="password" class="form-control" id="dbPassword" name="db_password" placeholder="è¯·è¾“å…¥å¯†ç " required>
                            </div>
                        </div>
                        <div class="row mb-3 align-items-start">
                            <label for="dbRemark" class="col-form-label edit-label">å¤‡æ³¨</label>
                            <div class="edit-input">
                                <textarea class="form-control" id="dbRemark" name="remark" rows="3" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯"></textarea>
                            </div>
                        </div>
                        <!-- æµ‹è¯•è¿æ¥æŒ‰é’® -->
                        <div class="row mb-3">
                            <div class="edit-label"></div>
                            <div class="edit-input">
                                <button type="button" class="btn btn-info" id="addTestConnectionBtn">æµ‹è¯•è¿æ¥</button>
                            </div>
                        </div>
                        <!-- è¿æ¥ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
                        <div class="row mb-3">
                            <div class="edit-label"></div>
                            <div class="edit-input">
                                <div id="addConnectionResult"></div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        // è¡¨å•éªŒè¯
        document.addEventListener('DOMContentLoaded', function() {
            // æ–°å¢è¡¨å•éªŒè¯
            var addForm = document.getElementById('addDatabaseForm');
            addForm.addEventListener('submit', function(e) {
                var isValid = this.checkValidity();
                if (!isValid) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                this.classList.add('was-validated');
            });
            
            // æ•°æ®åº“ç±»å‹åˆ‡æ¢æ—¶è‡ªåŠ¨æ›´æ–°é»˜è®¤ç«¯å£
            var dbTypeSelect = document.getElementById('dbType');
            var dbPortInput = document.getElementById('dbPort');
            
            dbTypeSelect.addEventListener('change', function() {
                var dbType = this.value;
                var defaultPort = '';
                
                // æ ¹æ®æ•°æ®åº“ç±»å‹è®¾ç½®é»˜è®¤ç«¯å£
                switch(dbType) {
                    case 'MySQL':
                        defaultPort = '3306';
                        break;
                    case 'SqlServer':
                        defaultPort = '1433';
                        break;
                    case 'PostgreSQL':
                        defaultPort = '5432';
                        break;
                    case 'Hive':
                        // Hiveä¸éœ€è¦æ”¹å˜ç«¯å£
                        break;
                    default:
                        defaultPort = '';
                }
                
                // å¦‚æœæœ‰é»˜è®¤ç«¯å£ï¼Œåˆ™è®¾ç½®é»˜è®¤ç«¯å£
                if (defaultPort) {
                    dbPortInput.value = defaultPort;
                }
            });
            
            // æµ‹è¯•è¿æ¥åŠŸèƒ½
            var testBtn = document.getElementById('addTestConnectionBtn');
            var resultDiv = document.getElementById('addConnectionResult');
            
            testBtn.addEventListener('click', function() {
                // è·å–è¡¨å•æ•°æ®
                var dbType = document.getElementById('dbType').value;
                var dbHost = document.getElementById('dbHost').value;
                var dbPort = document.getElementById('dbPort').value;
                var dbName = document.getElementById('dbName').value;
                var dbUser = document.getElementById('dbUser').value;
                var dbPassword = document.getElementById('dbPassword').value;
                
                // éªŒè¯å¿…å¡«å­—æ®µ
                if (!dbType || !dbHost || !dbPort || !dbName || !dbUser) {
                    resultDiv.innerHTML = '<div class="alert alert-danger">è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ</div>';
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                resultDiv.innerHTML = '<div class="alert alert-warning">æ­£åœ¨æµ‹è¯•è¿æ¥...</div>';
                
                // å‘é€AJAXè¯·æ±‚
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/databases/test-connection', true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                
                // æ„å»ºè¯·æ±‚å‚æ•°
                var params = new URLSearchParams();
                params.append('db_type', dbType);
                params.append('db_host', dbHost);
                params.append('db_port', dbPort);
                params.append('db_name', dbName);
                params.append('db_user', dbUser);
                params.append('db_password', dbPassword);
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            // è§£æå“åº”
                            var response = JSON.parse(xhr.responseText);
                            
                            // æ˜¾ç¤ºç»“æœ
                            if (response.success) {
                                resultDiv.innerHTML = '<div class="alert alert-success">' + response.message + '</div>';
                            } else {
                                resultDiv.innerHTML = '<div class="alert alert-danger">' + response.message + '</div>';
                            }
                        } else {
                            resultDiv.innerHTML = '<div class="alert alert-danger">æµ‹è¯•è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>';
                        }
                    }
                };
                
                // å‘é€è¯·æ±‚
                xhr.send(params.toString());
            });
        });
    </script>
</body>
</html>