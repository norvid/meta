<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ database.db_alias }} - å…ƒæ•°æ®ç®¡ç†</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ—„ï¸</text></svg>">
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/bootstrap-icons.min.css">
</head>
<body>
    <div class="container mt-1">
        <!-- é¢åŒ…å±‘è·¯å¾„ -->
        <nav aria-label="breadcrumb" class="mb-1">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="/databases" class="text-decoration-none">æ•°æ®åº“</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">{{ database.db_name }}</li>
            </ol>
        </nav>
        
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h1 class="mb-0 mt-0" style="margin: 5px 0;">{{ database.db_alias }}</h1>
            <div>
                <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#editDatabaseModal">
                    <i class="bi bi-pencil"></i> ç¼–è¾‘
                </button>
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteDatabaseModal">
                    <i class="bi bi-trash"></i> åˆ é™¤
                </button>
            </div>
        </div>
        
        <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center" id="infoCardHeader" style="cursor: pointer;">
                <h5 class="card-title mb-0">åŸºæœ¬ä¿¡æ¯</h5>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleInfoBtn">
                    <i class="bi bi-chevron-up" id="toggleIcon"></i>
                </button>
            </div>
            <div class="card-body" id="infoBody">
                <div class="row">
                    <div class="col-md-6">
                        <strong>ç±»å‹ï¼š</strong>{{ database.db_type }}
                    </div>
                    <div class="col-md-6">
                        <strong>åœ°å€ï¼š</strong>{{ database.db_host }}:{{ database.db_port }}
                    </div>
                    <div class="col-md-6">
                        <strong>æ•°æ®åº“ï¼š</strong>{{ database.db_name }}
                    </div>
                    <div class="col-md-6">
                        <strong>åˆ«åï¼š</strong>{{ database.db_alias }}
                    </div>
                    <div class="col-12 mt-2">
                        <strong>å¤‡æ³¨ï¼š</strong>{{ database.remark or 'æ— ' }}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">æ•°æ®è¡¨</h5>
                <button type="button" class="btn btn-success" id="syncTablesBtn">
                    <i class="bi bi-arrow-clockwise"></i> åŒæ­¥
                </button>
            </div>
            <div class="card-body">
                <!-- æœç´¢æ¡† -->
                <div class="mb-4">
                    <div class="d-flex align-items-center">
                        <input type="text" class="form-control me-2" placeholder="è¾“å…¥è¡¨åã€æ¨¡å¼æˆ–æ³¨é‡Šå…³é”®å­—" id="searchInput" name="keyword" value="{{ keyword }}" style="width: 50%;">
                        <button type="button" class="btn btn-primary" id="searchBtn" style="min-width: 100px;">
                            <i class="bi bi-search"></i> æŸ¥è¯¢
                        </button>
                        <button type="button" class="btn btn-secondary ms-2" id="resetBtn" style="min-width: 100px;">
                            <i class="bi bi-x-circle"></i> é‡ç½®
                        </button>
                        <span id="loading" class="ms-2 text-danger" style="display: none;">loading</span>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 20%;">æ¨¡å¼</th>
                                <th style="width: 30%;">è¡¨å</th>
                                <th style="width: 30%;">è¡¨æ³¨é‡Š</th>
                                <th style="width: 20%;">åˆ›å»ºæ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for table in tables.items %}
                            <tr>
                                <td>{{ table.schema_name }}</td>
                                <td>
                                    <a href="/database/{{ database.id }}/table/{{ table.schema_name }}/{{ table.table_name }}/info" class="text-decoration-none">
                                        {{ table.table_name }}
                                    </a>
                                </td>
                                <td>{{ table.table_comment or 'æ— ' }}</td>
                                <td>{{ table.create_time.strftime('%Y-%m-%d %H:%M:%S') if table.create_time else 'æœªçŸ¥' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- åˆ†é¡µä¿¡æ¯å’Œæ§ä»¶ -->
                <div class="d-flex justify-content-end mt-4">
                    <div class="me-4 mt-2">
                        <small id="recordTotal">å…± {{ tables.total }} æ¡è®°å½•</small>
                    </div>
                    <nav aria-label="Page navigation example">
                        <ul class="pagination">
                            {% if tables.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ tables.prev_num }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% endif %}
                            
                            {% for page_num in tables.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                                {% if page_num %}
                                    {% if tables.page == page_num %}
                                    <li class="page-item active">
                                        <a class="page-link" href="#">{{ page_num }}</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                                    </li>
                                    {% endif %}
                                {% else %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#">...</a>
                                </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if tables.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ tables.next_num }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘æ•°æ®åº“æ¨¡æ€æ¡† -->
    <div class="modal fade" id="editDatabaseModal" tabindex="-1" aria-labelledby="editDatabaseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editDatabaseModalLabel">ç¼–è¾‘æ•°æ®åº“</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editDatabaseForm" method="POST" action="/databases/edit">
                    <input type="hidden" id="editDbId" name="id" value="{{ database.id }}">
                    <div class="modal-body">
                        <style>
                            .edit-label {
                                width: calc(25% - 70px); /* å†å‡å°‘30pxï¼Œæ€»å…±ç¼©å°70px */
                                min-width: 100px;
                            }
                            .edit-input {
                                width: calc(75% + 70px); /* å¯¹åº”å¢åŠ 70px */
                            }
                        </style>
                        <div class="row mb-3 align-items-center">
                            <label for="editDbAlias" class="col-form-label edit-label">æ•°æ®åº“åˆ«å <span class="text-danger">*</span></label>
                            <div class="edit-input">
                                <input type="text" class="form-control" id="editDbAlias" name="db_alias" placeholder="è¯·è¾“å…¥ä¸­æ–‡åˆ«å" value="{{ database.db_alias }}" required>
                            </div>
                        </div>
                        <div class="row mb-3 align-items-center">
                            <label for="editDbHost" class="col-form-label edit-label">åœ°å€ <span class="text-danger">*</span></label>
                            <div class="edit-input">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="editDbHost" name="db_host" placeholder="è¯·è¾“å…¥IPåœ°å€" value="{{ database.db_host }}" required>
                                    <input type="number" class="form-control" id="editDbPort" name="db_port" placeholder="ç«¯å£" min="1" max="65535" value="{{ database.db_port }}" required>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3 align-items-center">
                            <label for="editDbName" class="col-form-label edit-label">æ•°æ®åº“å <span class="text-danger">*</span></label>
                            <div class="edit-input">
                                <input type="text" class="form-control" id="editDbName" name="db_name" placeholder="è¯·è¾“å…¥æ•°æ®åº“å" value="{{ database.db_name }}" required>
                            </div>
                        </div>
                        <div class="row mb-3 align-items-center">
                            <label for="editDbUser" class="col-form-label edit-label">ç”¨æˆ·å <span class="text-danger">*</span></label>
                            <div class="edit-input">
                                <input type="text" class="form-control" id="editDbUser" name="db_user" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" value="{{ database.db_user }}" required>
                            </div>
                        </div>
                        <div class="row mb-3 align-items-center">
                            <label for="editDbPassword" class="col-form-label edit-label">å¯†ç </label>
                            <div class="edit-input">
                                <input type="password" class="form-control" id="editDbPassword" name="db_password" placeholder="è¯·è¾“å…¥å¯†ç " disabled>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="edit-label"></div>
                            <div class="edit-input">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="updatePassword" name="update_password">
                                    <label class="form-check-label" for="updatePassword">ä¿®æ”¹å¯†ç </label>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3 align-items-start">
                            <label for="editDbRemark" class="col-form-label edit-label">å¤‡æ³¨</label>
                            <div class="edit-input">
                                <textarea class="form-control" id="editDbRemark" name="remark" rows="3" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯">{{ database.remark or '' }}</textarea>
                            </div>
                        </div>
                        <!-- æµ‹è¯•è¿æ¥æŒ‰é’® -->
                        <div class="row mb-3">
                            <div class="edit-label"></div>
                            <div class="edit-input">
                                <button type="button" class="btn btn-info" id="testConnectionBtn">æµ‹è¯•è¿æ¥</button>
                            </div>
                        </div>
                        <!-- è¿æ¥ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
                        <div class="row mb-3">
                            <div class="edit-label"></div>
                            <div class="edit-input">
                                <div id="connectionResult"></div>
                            </div>
                        </div>
                        
                        <!-- æ·»åŠ ä¿®æ”¹å¯†ç çš„JavaScriptå¤„ç† -->
                        <script>
                            // è·å–ä¿®æ”¹å¯†ç çš„checkboxå’Œå¯†ç è¾“å…¥æ¡†
                            const updatePasswordCheckbox = document.getElementById('updatePassword');
                            const passwordInput = document.getElementById('editDbPassword');
                            
                            // ç›‘å¬checkboxçš„å˜åŒ–äº‹ä»¶
                            updatePasswordCheckbox.addEventListener('change', function() {
                                if (this.checked) {
                                    // å¦‚æœå‹¾é€‰äº†ä¿®æ”¹å¯†ç ï¼Œå¯ç”¨å¯†ç è¾“å…¥æ¡†
                                    passwordInput.disabled = false;
                                    passwordInput.setAttribute('required', 'required');
                                } else {
                                    // å¦‚æœå–æ¶ˆå‹¾é€‰ï¼Œç¦ç”¨å¯†ç è¾“å…¥æ¡†å¹¶æ¸…ç©ºå†…å®¹
                                    passwordInput.disabled = true;
                                    passwordInput.removeAttribute('required');
                                    passwordInput.value = '';
                                }
                            });
                        </script>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- åˆ é™¤æ•°æ®åº“æ¨¡æ€æ¡† -->
    <div class="modal fade" id="deleteDatabaseModal" tabindex="-1" aria-labelledby="deleteDatabaseModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteDatabaseModalLabel">ç¡®è®¤åˆ é™¤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>ç¡®å®šè¦åˆ é™¤æ•°æ®åº“ <strong>{{ database.db_alias }}</strong> å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <form method="POST" action="/databases/delete" style="display: inline;">
                        <input type="hidden" name="id" value="{{ database.id }}">
                        <button type="submit" class="btn btn-danger">åˆ é™¤</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        // è¡¨å•éªŒè¯
        document.addEventListener('DOMContentLoaded', function() {
            var editForm = document.getElementById('editDatabaseForm');
            editForm.addEventListener('submit', function(e) {
                var isValid = this.checkValidity();
                if (!isValid) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                this.classList.add('was-validated');
            });
            
            // åŸºæœ¬ä¿¡æ¯å¡ç‰‡æŠ˜å /å±•å¼€åŠŸèƒ½
            const toggleInfoBtn = document.getElementById('toggleInfoBtn');
            const infoCardHeader = document.getElementById('infoCardHeader');
            const infoBody = document.getElementById('infoBody');
            const toggleIcon = document.getElementById('toggleIcon');
            
            // æŠ˜å /å±•å¼€å‡½æ•°
            function toggleInfo() {
                if (infoBody.style.display === 'none') {
                    // å±•å¼€
                    infoBody.style.display = 'block';
                    toggleIcon.classList.remove('bi-chevron-down');
                    toggleIcon.classList.add('bi-chevron-up');
                } else {
                    // æŠ˜å 
                    infoBody.style.display = 'none';
                    toggleIcon.classList.remove('bi-chevron-up');
                    toggleIcon.classList.add('bi-chevron-down');
                }
            }
            
            // æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            toggleInfoBtn.addEventListener('click', toggleInfo);
            
            // æ ‡é¢˜æ åŒå‡»äº‹ä»¶
            infoCardHeader.addEventListener('dblclick', toggleInfo);
            
            // AJAXæœç´¢åŠŸèƒ½
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            const resetBtn = document.getElementById('resetBtn');
            const loading = document.getElementById('loading');
            const tbody = document.querySelector('.table tbody');
            
            function performSearch(keyword) {
                loading.style.display = 'inline';
                
                // å¼ºåˆ¶æ”¶èµ·åŸºæœ¬ä¿¡æ¯å¡ç‰‡
                infoBody.style.display = 'none';
                toggleIcon.classList.remove('bi-chevron-up');
                toggleIcon.classList.add('bi-chevron-down');
                
                // å‘é€AJAXè¯·æ±‚
                var xhr = new XMLHttpRequest();
                xhr.open('GET', `/database/{{ database.id }}/tables?keyword=${encodeURIComponent(keyword)}&page=1`, true);
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        // æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½éšè—loading
                        loading.style.display = 'none';
                        
                        if (xhr.status === 200) {
                            // è§£æHTMLå“åº”
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(xhr.responseText, 'text/html');
                            
                            // æ›´æ–°è¡¨æ ¼å†…å®¹
                            const newTbody = doc.querySelector('.table tbody');
                            tbody.innerHTML = newTbody.innerHTML;
                            
                            // æ›´æ–°åˆ†é¡µä¿¡æ¯
                            const newPagination = doc.querySelector('.pagination');
                            const oldPagination = document.querySelector('.pagination');
                            oldPagination.innerHTML = newPagination.innerHTML;
                            
                            // æ›´æ–°æ€»æ•°ä¿¡æ¯
                            const newTotal = doc.getElementById('recordTotal');
                            const oldTotal = document.getElementById('recordTotal');
                            oldTotal.innerHTML = newTotal.innerHTML;
                        }
                    }
                };
                
                xhr.send();
            }
            
            // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            searchBtn.addEventListener('click', function() {
                const keyword = searchInput.value;
                performSearch(keyword);
            });
            
            // é‡ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            resetBtn.addEventListener('click', function() {
                searchInput.value = '';
                performSearch('');
            });
            
            // å›è½¦é”®æœç´¢
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const keyword = searchInput.value;
                    performSearch(keyword);
                }
            });
            
            // æµ‹è¯•è¿æ¥åŠŸèƒ½
            var testBtn = document.getElementById('testConnectionBtn');
            var resultDiv = document.getElementById('connectionResult');
            
            testBtn.addEventListener('click', function() {
                // è·å–è¡¨å•æ•°æ®
                var dbType = '{{ database.db_type }}';
                var dbHost = document.getElementById('editDbHost').value;
                var dbPort = document.getElementById('editDbPort').value;
                var dbName = document.getElementById('editDbName').value;
                var dbUser = document.getElementById('editDbUser').value;
                var editDbPassword = document.getElementById('editDbPassword');
                var dbPassword = editDbPassword.value;
                
                // éªŒè¯å¿…å¡«å­—æ®µ
                if (!dbHost || !dbPort || !dbName || !dbUser) {
                    resultDiv.innerHTML = '<div class="alert alert-danger">è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ</div>';
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                resultDiv.innerHTML = '<div class="alert alert-warning">æ­£åœ¨æµ‹è¯•è¿æ¥...</div>';
                
                // å‘é€AJAXè¯·æ±‚
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/databases/test-connection', true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                
                // æ„å»ºè¯·æ±‚å‚æ•°
                var params = new URLSearchParams();
                params.append('id', document.getElementById('editDbId').value);  // æ·»åŠ æ•°æ®åº“ID
                params.append('db_type', dbType);
                params.append('db_host', dbHost);
                params.append('db_port', dbPort);
                params.append('db_name', dbName);
                params.append('db_user', dbUser);
                params.append('db_password', dbPassword);
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            // è§£æå“åº”
                            var response = JSON.parse(xhr.responseText);
                            
                            // æ˜¾ç¤ºç»“æœ
                            if (response.success) {
                                resultDiv.innerHTML = '<div class="alert alert-success">' + response.message + '</div>';
                            } else {
                                resultDiv.innerHTML = '<div class="alert alert-danger">' + response.message + '</div>';
                            }
                        } else {
                            resultDiv.innerHTML = '<div class="alert alert-danger">æµ‹è¯•è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>';
                        }
                    }
                };
                
                // å‘é€è¯·æ±‚
                xhr.send(params.toString());
            });
            
            // åŒæ­¥è¡¨ä¿¡æ¯åŠŸèƒ½
            function syncTables() {
                // è·å–åŒæ­¥æŒ‰é’®
                const syncBtn = document.getElementById('syncTablesBtn');
                const originalBtnText = syncBtn.innerHTML;
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€å¹¶ç¦ç”¨æŒ‰é’®
                syncBtn.innerHTML = '<i class="bi bi-arrow-clockwise bi-spin"></i> åŒæ­¥ä¸­...';
                syncBtn.disabled = true;
                
                // å‘é€AJAXè¯·æ±‚å¯åŠ¨åŒæ­¥
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/database/{{ database.id }}/sync-tables', true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            // è§£æå“åº”
                            var response = JSON.parse(xhr.responseText);
                            
                            if (response.success) {
                                // è·å–token
                                const token = response.token;
                                
                                // åˆå§‹åŒ–è½®è¯¢å‚æ•°
                                let pollInterval = 3000; // åˆå§‹3ç§’
                                let pollCount = 0;
                                const maxFastPolls = 10; // 3ç§’ * 10 = 30ç§’
                                
                                // è®¾ç½®è½®è¯¢
                                const pollTimer = setInterval(function() {
                                    checkSyncStatus(token, pollTimer);
                                    pollCount++;
                                    
                                    // è¶…è¿‡30ç§’åæ”¹ä¸º10ç§’è½®è¯¢
                                    if (pollCount >= maxFastPolls && pollInterval === 3000) {
                                        clearInterval(pollTimer);
                                        pollInterval = 10000; // æ”¹ä¸º10ç§’
                                        setInterval(function() {
                                            checkSyncStatus(token, null); // ä¸å†æ¸…é™¤å®šæ—¶å™¨ï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆ
                                        }, pollInterval);
                                    }
                                }, pollInterval);
                                
                                // ç«‹å³æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€
                                checkSyncStatus(token, pollTimer);
                            } else {
                                // æ¢å¤æŒ‰é’®çŠ¶æ€
                                syncBtn.innerHTML = originalBtnText;
                                syncBtn.disabled = false;
                                
                                // æ˜¾ç¤ºå¤±è´¥å¼¹çª—
                                showSyncModal(false, response.message);
                            }
                        } else {
                            // æ¢å¤æŒ‰é’®çŠ¶æ€
                            syncBtn.innerHTML = originalBtnText;
                            syncBtn.disabled = false;
                            
                            // æ˜¾ç¤ºç½‘ç»œé”™è¯¯å¼¹çª—
                            showSyncModal(false, 'åŒæ­¥è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                        }
                    }
                };
                
                // å‘é€è¯·æ±‚
                xhr.send();
            }
            
            // æ£€æŸ¥åŒæ­¥çŠ¶æ€
            function checkSyncStatus(token, pollTimer) {
                const syncBtn = document.getElementById('syncTablesBtn');
                
                var xhr = new XMLHttpRequest();
                xhr.open('GET', `/database/{{ database.id }}/sync-status?token=${token}`, true);
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        // è§£æå“åº”
                        var response = JSON.parse(xhr.responseText);
                        
                        if (response.status === 'loading') {
                            // ç»§ç»­è½®è¯¢
                            console.log('åŒæ­¥ä¸­...');
                        } else if (response.status === 'success' || response.status === 'error') {
                            // æ¸…é™¤è½®è¯¢
                            clearInterval(pollTimer);
                            
                            // æ¢å¤æŒ‰é’®çŠ¶æ€
                            syncBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> åŒæ­¥';
                            syncBtn.disabled = false;
                            
                            // æ˜¾ç¤ºç»“æœ
                            showSyncModal(response.status === 'success', response.msg);
                            
                            // å¦‚æœæˆåŠŸï¼Œåˆ·æ–°é¡µé¢
                            if (response.status === 'success') {
                                setTimeout(function() {
                                    window.location.reload();
                                }, 2000);
                            }
                        }
                    }
                };
                
                // å‘é€è¯·æ±‚
                xhr.send();
            }
            
            // æ˜¾ç¤ºåŒæ­¥ç»“æœå¼¹çª—
            function showSyncModal(success, message) {
                // æ˜¾ç¤ºç»“æœå¼¹çª—
                var modal = document.createElement('div');
                modal.className = 'modal fade show d-block';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">åŒæ­¥ç»“æœ</h5>
                                <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-${success ? 'success' : 'danger'} mb-0">
                                    ${message}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" onclick="this.closest('.modal').remove()">å…³é—­</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­äº‹ä»¶
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
            
            // å…³é—­åŒæ­¥ç»“æœå¼¹çª—å¹¶åˆ·æ–°é¡µé¢
            function closeSyncModal(btn) {
                const modal = btn.closest('.modal');
                modal.remove();
                // åˆ·æ–°é¡µé¢
                window.location.reload();
            }
            
            // ç»‘å®šåŒæ­¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            const syncBtn = document.getElementById('syncTablesBtn');
            syncBtn.addEventListener('click', syncTables);
        });
</script>
</body>
</html>